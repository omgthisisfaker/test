<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Piano Game</title>
    <style>
        body { background-color: #333; color: white; text-align: center; font-family: sans-serif; user-select: none;}
        #connectBtn { font-size: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; margin: 20px; }
        .key { width: 90%; height: 60px; margin: 10px auto; background: white; border-radius: 10px; color: black; line-height: 60px; font-size: 24px; font-weight: bold; border: 5px solid #000;}
        .active { background-color: #6eff6e; }
        .target { border-color: #ff4444; }
        #status { font-size: 18px; color: #aaa; margin-bottom: 20px;}
        #targetDisplay { font-size: 40px; color: yellow; margin: 10px;}
    </style>
</head>
<body>

    <button id="connectBtn">連接藍牙 (ESP32 BLE)</button>
    <div id="status">未連線</div>
    <div id="targetDisplay">目標: Do</div>
    <div id="piano-container"></div>

    <script>
        // --- 設定與變數 ---
        const serviceUUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
        const txUUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // 收
        const rxUUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; // 發

        let bleDevice, bleServer, rxChar, txChar;
        let currentTarget = 1;
        let isPressed = false;
        const notes = ["", "Do", "Re", "Mi", "Fa", "Sol", "La", "Si"];
        
        // 預載音效
        const sounds = {};
        for(let i=1; i<=7; i++) sounds[i] = new Audio(i + ".wav");

        // 產生琴鍵 UI
        const container = document.getElementById("piano-container");
        for(let i=1; i<=7; i++) {
            let div = document.createElement("div");
            div.className = "key";
            div.id = "key-" + i;
            div.innerText = notes[i];
            container.appendChild(div);
        }
        updateUI();

        // --- 藍牙連線 ---
        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                // 1. 搜尋裝置
                document.getElementById("status").innerText = "搜尋中...";
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'ESP32 Piano' }],
                    optionalServices: [serviceUUID]
                });

                // 2. 連線
                bleServer = await bleDevice.gatt.connect();
                const service = await bleServer.getPrimaryService(serviceUUID);
                
                // 3. 取得特徵
                rxChar = await service.getCharacteristic(rxUUID); // 寫入 (控制燈)
                txChar = await service.getCharacteristic(txUUID); // 接收 (監聽按鈕)

                // 4. 開啟通知 (監聽 ESP32 傳來的訊息)
                await txChar.startNotifications();
                txChar.addEventListener('characteristicvaluechanged', handleInput);

                document.getElementById("status").innerText = "已連線！";
                document.getElementById("connectBtn").style.display = "none";
                
                // 開始遊戲迴圈 (發送指令亮燈)
                sendLightCommand();

            } catch (error) {
                console.error(error);
                document.getElementById("status").innerText = "連線失敗: " + error;
            }
        });

        // --- 處理來自 ESP32 的資料 ---
        function handleInput(event) {
            let val = new TextDecoder().decode(event.target.value);
            let char = val.charAt(0);
            
            let note = -1;
            let press = false;

            if (char >= 'A' && char <= 'G') { note = char.charCodeAt(0) - 64; press = true; } // A=65
            else if (char >= 'a' && char <= 'g') { note = char.charCodeAt(0) - 96; press = false; } // a=97

            if (note >= 1 && note <= 7) {
                let keyDiv = document.getElementById("key-" + note);
                if (press) {
                    keyDiv.classList.add("active");
                    // 播放聲音 (重置播放時間以支援連點)
                    sounds[note].currentTime = 0;
                    sounds[note].play();

                    if (note == currentTarget) isPressed = true;
                } else {
                    keyDiv.classList.remove("active");
                    // 過關判定
                    if (note == currentTarget && isPressed) {
                        isPressed = false;
                        currentTarget++;
                        if (currentTarget > 7) currentTarget = 1;
                        updateUI();
                        sendLightCommand();
                    }
                }
            }
        }

        // 發送亮燈指令給 ESP32
        async function sendLightCommand() {
            if (rxChar) {
                let data = new TextEncoder().encode(currentTarget.toString());
                await rxChar.writeValue(data);
            }
        }

        function updateUI() {
            document.getElementById("targetDisplay").innerText = "目標: " + notes[currentTarget];
            // 更新紅色目標框
            for(let i=1; i<=7; i++) {
                let el = document.getElementById("key-" + i);
                if(i === currentTarget) el.classList.add("target");
                else el.classList.remove("target");
            }
        }
    </script>
</body>
</html>