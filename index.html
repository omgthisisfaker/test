<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>極簡雙板測試</title>
    <style>
        body { background-color: #eee; text-align: center; font-family: sans-serif; padding: 50px;}
        button { font-size: 20px; padding: 15px 30px; margin: 10px; cursor: pointer; }
        #status { font-size: 24px; color: #333; margin: 20px; font-weight: bold;}
        .box { width: 100px; height: 100px; background: #ccc; margin: 20px auto; border-radius: 50%; border: 5px solid #666;}
        .active { background-color: red; box-shadow: 0 0 20px red; border-color: red;}
    </style>
</head>
<body>

    <h2>第一步：連接兩個裝置</h2>
    <button id="btnA">1. 連接按鈕板 (TEST_BTN_BOARD)</button>
    <button id="btnB">2. 連接燈光板 (TEST_LED_BOARD)</button>

    <div id="status">等待連線...</div>

    <h2>第二步：按下實體按鈕測試</h2>
    <div id="visualBox" class="box"></div>

    <script>
        // UUID 設定
        const BTN_SERVICE = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
        const BTN_TX_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; 
        
        const LED_SERVICE = "6e400001-b5a3-f393-e0a9-e50e24dcca9f";
        const LED_RX_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9f";

        let rxCharLED; // 這是要傳給燈的通道

        // --- 連接按鈕板 ---
        document.getElementById('btnA').addEventListener('click', async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'TEST_BTN_BOARD' }],
                    optionalServices: [BTN_SERVICE]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(BTN_SERVICE);
                const txChar = await service.getCharacteristic(BTN_TX_UUID);
                await txChar.startNotifications();
                txChar.addEventListener('characteristicvaluechanged', handleInput);
                
                document.getElementById('btnA').innerText = "按鈕板 OK";
                document.getElementById('btnA').disabled = true;
                checkStatus();
            } catch (e) { alert(e); }
        });

        // --- 連接燈光板 ---
        document.getElementById('btnB').addEventListener('click', async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'TEST_LED_BOARD' }],
                    optionalServices: [LED_SERVICE]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(LED_SERVICE);
                rxCharLED = await service.getCharacteristic(LED_RX_UUID);

                document.getElementById('btnB').innerText = "燈光板 OK";
                document.getElementById('btnB').disabled = true;
                checkStatus();
            } catch (e) { alert(e); }
        });

        function checkStatus() {
            if (document.getElementById('btnA').disabled && document.getElementById('btnB').disabled) {
                document.getElementById('status').innerText = "測試開始！請按實體按鈕";
            }
        }

        // --- 核心邏輯：收到 A -> 控制 B ---
        async function handleInput(event) {
            let val = new TextDecoder().decode(event.target.value);
            let char = val.charAt(0); // 收到 'A' 或 'a'
            
            let box = document.getElementById("visualBox");

            if (char === 'A') {
                // 按下
                box.classList.add("active");
                document.getElementById('status').innerText = "按鈕狀態：按下";
                
                // 發送 '1' 給燈光板
                if(rxCharLED) await rxCharLED.writeValue(new TextEncoder().encode("1"));

            } else if (char === 'a') {
                // 放開
                box.classList.remove("active");
                document.getElementById('status').innerText = "按鈕狀態：放開";

                // 發送 '0' 給燈光板
                if(rxCharLED) await rxCharLED.writeValue(new TextEncoder().encode("0"));
            }
        }
    </script>
</body>
</html>
