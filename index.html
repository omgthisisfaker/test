<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Piano Solo</title>
    <style>
        body { background-color: #222; color: white; text-align: center; font-family: sans-serif; user-select: none; touch-action: manipulation;}
        #connectBtn { font-size: 22px; padding: 15px 30px; background: #00d4ff; color: #000; border: none; border-radius: 50px; margin: 30px; font-weight: bold; box-shadow: 0 0 15px #00d4ff;}
        
        .key { width: 90%; height: 60px; margin: 10px auto; background: white; border-radius: 10px; color: black; line-height: 60px; font-size: 24px; font-weight: bold; border: 5px solid #000; transition: all 0.1s;}
        .active { background-color: #6eff6e; transform: scale(0.95); }
        .target { border-color: #ff4444; box-shadow: 0 0 10px #ff4444; }
        
        #targetDisplay { font-size: 50px; color: yellow; margin: 20px; text-shadow: 2px 2px 0 #000;}
        #status { color: #888; margin-bottom: 20px;}
    </style>
</head>
<body>

    <button id="connectBtn">ğŸµ é–‹å§‹é€£æ¥é‹¼ç´</button>
    <div id="status">è«‹ç¢ºä¿ ESP32 å·²é€šé›»</div>
    <div id="targetDisplay">ç›®æ¨™: Do</div>
    <div id="piano-container"></div>

    <script>
        // UUID è¨­å®š (èˆ‡ ESP32 ç¨‹å¼ç¢¼ä¸€è‡´)
        const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
        const RX_UUID      = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; // å¯«å…¥ (ç‡ˆ)
        const TX_UUID      = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // é€šçŸ¥ (æŒ‰éˆ•)

        let bleDevice, rxChar;
        let currentTarget = 1;
        let isPressed = false;
        const notes = ["", "Do", "Re", "Mi", "Fa", "Sol", "La", "Si"];
        
        // é è¼‰éŸ³æ•ˆ
        const sounds = {};
        for(let i=1; i<=7; i++) sounds[i] = new Audio(i + ".wav");

        // å»ºç«‹ç´éµä»‹é¢
        const container = document.getElementById("piano-container");
        for(let i=1; i<=7; i++) {
            let div = document.createElement("div");
            div.className = "key"; div.id = "key-" + i; div.innerText = notes[i];
            container.appendChild(div);
        }
        updateUI();

        // --- é€£ç·šé‚è¼¯ ---
        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                document.getElementById("status").innerText = "æœå°‹ä¸­...";
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'ESP32 Piano Solo' }],
                    optionalServices: [SERVICE_UUID]
                });

                const server = await bleDevice.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                
                rxChar = await service.getCharacteristic(RX_UUID); // æº–å‚™å‚³æŒ‡ä»¤
                const txChar = await service.getCharacteristic(TX_UUID); // æº–å‚™æ”¶è¨Šè™Ÿ

                await txChar.startNotifications();
                txChar.addEventListener('characteristicvaluechanged', handleInput);

                document.getElementById("status").innerText = "å·²é€£ç·šï¼éŠæˆ²é–‹å§‹";
                document.getElementById("connectBtn").style.display = "none";
                
                sendLightCommand(); // äº®ç¬¬ä¸€å€‹ç‡ˆ

            } catch (error) {
                alert("é€£ç·šå¤±æ•—ï¼š" + error);
                document.getElementById("status").innerText = "é€£ç·šå¤±æ•—";
            }
        });

        // --- è™•ç† ESP32 å‚³ä¾†çš„æŒ‰éµè¨Šè™Ÿ ---
        function handleInput(event) {
            let val = new TextDecoder().decode(event.target.value);
            let char = val.charAt(0);
            
            let note = -1; let press = false;

            if (char >= 'A' && char <= 'G') { note = char.charCodeAt(0) - 64; press = true; } 
            else if (char >= 'a' && char <= 'g') { note = char.charCodeAt(0) - 96; press = false; }

            if (note >= 1 && note <= 7) {
                let keyDiv = document.getElementById("key-" + note);
                if (press) {
                    // æŒ‰ä¸‹
                    keyDiv.classList.add("active");
                    sounds[note].currentTime = 0;
                    sounds[note].play();

                    if (note == currentTarget) isPressed = true;
                } else {
                    // æ”¾é–‹
                    keyDiv.classList.remove("active");
                    
                    // éé—œåˆ¤å®šï¼šæ”¾é–‹çš„æ˜¯ç›®æ¨™éµï¼Œä¸”å‰›æ‰ç¢ºå¯¦æœ‰æŒ‰ä¸‹å»
                    if (note == currentTarget && isPressed) {
                        isPressed = false;
                        currentTarget++;
                        if (currentTarget > 7) currentTarget = 1; // å¾ªç’°
                        updateUI();
                        sendLightCommand(); // äº®ä¸‹ä¸€å€‹ç‡ˆ
                    }
                }
            }
        }

        async function sendLightCommand() {
            if (rxChar) {
                let data = new TextEncoder().encode(currentTarget.toString());
                await rxChar.writeValue(data);
            }
        }

        function updateUI() {
            document.getElementById("targetDisplay").innerText = "ç›®æ¨™: " + notes[currentTarget];
            for(let i=1; i<=7; i++) {
                let el = document.getElementById("key-" + i);
                if(i === currentTarget) el.classList.add("target");
                else el.classList.remove("target");
            }
        }
    </script>
</body>
</html>
