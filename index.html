<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ESP32 éŸ³æ¨‚åæ‡‰éŠæˆ²</title>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; text-align: center; background: #222; color: white; }
        .box { border: 1px solid #555; padding: 20px; margin: 10px auto; max-width: 500px; border-radius: 10px; background: #333; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; border: none; }
        .btn-connect { background: #007bff; color: white; margin: 5px; }
        .btn-start { background: #28a745; color: white; font-size: 24px; padding: 15px 40px; margin-top: 20px; display: none;}
        .status-ok { color: #4cff00; font-weight: bold; }
        
        #gameArea { margin-top: 30px; font-size: 20px; display: none; }
        .current-note { font-size: 60px; color: yellow; font-weight: bold; margin: 20px 0; }
        .timer { font-size: 30px; color: #00d2ff; }
        .score-display { letter-spacing: 5px; color: #aaa; margin-top: 10px;}
        .highlight { color: yellow; text-decoration: underline; }
    </style>
</head>
<body>

    <h1>ğŸµ ESP32 éŸ³æ¨‚åæ‡‰æŒ‘æˆ°</h1>

    <div class="box">
        <h3>1. è£ç½®é€£ç·š</h3>
        <p>LEDæ¿ç‹€æ…‹: <span id="ledStatus">æœªé€£ç·š âŒ</span></p>
        <button class="btn-connect" onclick="connectLed()">é€£æ¥ LED æ¿</button>
        
        <p>æŒ‰éˆ•æ¿ç‹€æ…‹: <span id="btnStatus">æœªé€£ç·š âŒ</span></p>
        <button class="btn-connect" onclick="connectBtn()">é€£æ¥ æŒ‰éˆ• æ¿</button>
    </div>

    <div class="box" id="controlBox">
        <h3>2. é¸æ“‡æ¨‚è­œä¸¦é–‹å§‹</h3>
        <select id="songSelect" style="padding: 10px; font-size: 16px;">
            <option value="1,1,5,5,6,6,5">å°æ˜Ÿæ˜Ÿ (1 1 5 5 6 6 5)</option>
            <option value="5,3,3,4,2,2,1,2,3,4,5">å°èœœèœ‚ (5 3 3 4 2 2 1 2 3 4 5)</option>
            <option value="1,2,3,4,5,5,4,3,2,1">éŸ³éšç·´ç¿’ (1 2 3 4 5...)</option>
        </select>
        <br>
        <button id="startBtn" class="btn-start" onclick="startGame()">é–‹å§‹éŠæˆ²ï¼</button>
    </div>

    <div id="gameArea">
        <div class="timer">æ™‚é–“: <span id="timeDisplay">0.00</span> ç§’</div>
        <div id="instruction">è«‹æŒ‰ä¸‹äº®ç‡ˆå°æ‡‰çš„æŒ‰éˆ•ï¼</div>
        <div class="current-note" id="noteDisplay">-</div>
        <div class="score-display" id="fullScore"></div>
    </div>

<script>
    // è—ç‰™ UUID è¨­å®š
    const LED_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const LED_CHAR = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
    const BTN_UUID = "1234c201-1fb5-459e-8fcc-c5c9c331914b";
    const BTN_CHAR = "5678483e-36e1-4688-b7f5-ea07361b26a8";

    let ledCharacteristic = null;
    let isGameRunning = false;
    let currentSong = [];
    let noteIndex = 0;
    let startTime = 0;
    let timerInterval = null;

    // --- è—ç‰™é€£ç·šåŠŸèƒ½ ---
    async function connectLed() {
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ name: 'ESP32_LED_Control' }], optionalServices: [LED_UUID]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(LED_UUID);
            ledCharacteristic = await service.getCharacteristic(LED_CHAR);
            document.getElementById('ledStatus').innerHTML = "å·²é€£ç·š âœ…";
            document.getElementById('ledStatus').className = "status-ok";
            checkReady();
        } catch (e) { alert("LED é€£ç·šå¤±æ•—: " + e); }
    }

    async function connectBtn() {
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ name: 'ESP32_Button_Input' }], optionalServices: [BTN_UUID]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(BTN_UUID);
            const characteristic = await service.getCharacteristic(BTN_CHAR);
            await characteristic.startNotifications();
            characteristic.addEventListener('characteristicvaluechanged', handleButtonInput);
            
            document.getElementById('btnStatus').innerHTML = "å·²é€£ç·š âœ…";
            document.getElementById('btnStatus').className = "status-ok";
            checkReady();
        } catch (e) { alert("æŒ‰éˆ•é€£ç·šå¤±æ•—: " + e); }
    }

    function checkReady() {
        if (document.getElementById('ledStatus').className.includes('ok') && 
            document.getElementById('btnStatus').className.includes('ok')) {
            document.getElementById('startBtn').style.display = 'inline-block';
        }
    }

    // --- éŠæˆ²æ ¸å¿ƒé‚è¼¯ ---
    function startGame() {
        // 1. è®€å–æ¨‚è­œ
        const val = document.getElementById('songSelect').value;
        currentSong = val.split(',').map(Number); // è½‰æˆæ•¸å­—é™£åˆ—
        noteIndex = 0;
        isGameRunning = true;

        // 2. ä»‹é¢åˆå§‹åŒ–
        document.getElementById('gameArea').style.display = 'block';
        document.getElementById('controlBox').style.display = 'none';
        document.getElementById('fullScore').innerText = "æ¨‚è­œ: " + currentSong.join(" ");
        document.getElementById('timeDisplay').innerText = "0.00";
        
        // 3. é–‹å§‹è¨ˆæ™‚èˆ‡äº®ç¬¬ä¸€å€‹ç‡ˆ
        startTime = Date.now();
        timerInterval = setInterval(() => {
            let t = (Date.now() - startTime) / 1000;
            document.getElementById('timeDisplay').innerText = t.toFixed(2);
        }, 50);

        playNextNote();
    }

    function playNextNote() {
        if (noteIndex >= currentSong.length) {
            endGame();
            return;
        }

        let target = currentSong[noteIndex];
        document.getElementById('noteDisplay').innerText = "ç›®æ¨™: " + target;
        
        // å‚³é€æŒ‡ä»¤çµ¦ ESP32 äº®ç‡ˆ (å‚³é€å­—å…ƒ '1'~'5')
        if (ledCharacteristic) {
            let cmd = new TextEncoder().encode(String(target));
            ledCharacteristic.writeValue(cmd);
        }
    }

    function handleButtonInput(event) {
        if (!isGameRunning) return;

        // è®€å–æŒ‰éˆ•æ¿å‚³ä¾†çš„è¨Šè™Ÿ ('1', '2', '3'...)
        let val = new TextDecoder().decode(event.target.value);
        let pressedBtn = parseInt(val);

        let target = currentSong[noteIndex];

        // æ ¸å¿ƒè¦å‰‡ï¼šåªæœ‰æŒ‰å°äº†é‚£ä¸€é¡†æŒ‰éˆ•ï¼ŒéŠæˆ²æ‰æœƒç¹¼çºŒ
        if (pressedBtn === target) {
            console.log("æ­£ç¢ºï¼æ›ä¸‹ä¸€å€‹");
            noteIndex++;
            playNextNote();
        } else {
            console.log("æŒ‰éŒ¯äº†ï¼ç›®æ¨™æ˜¯ " + target + " ä½ æŒ‰äº† " + pressedBtn);
            // å¯ä»¥åœ¨é€™è£¡åŠ å€‹éŒ¯èª¤éŸ³æ•ˆï¼Œç›®å‰è¨­å®šæ˜¯ä¸åæ‡‰
        }
    }

    function endGame() {
        isGameRunning = false;
        clearInterval(timerInterval);
        
        // é—œç‡ˆ
        if (ledCharacteristic) {
            ledCharacteristic.writeValue(new TextEncoder().encode('0'));
        }

        let finalTime = document.getElementById('timeDisplay').innerText;
        document.getElementById('noteDisplay').innerText = "ğŸ‰ å®Œæˆï¼";
        document.getElementById('instruction').innerHTML = "ç¸½æ™‚é–“: <b style='font-size:40px'>" + finalTime + "</b> ç§’";
        
        // é¡¯ç¤ºé‡ç©æŒ‰éˆ•
        setTimeout(() => {
            if(confirm("æ­å–œå®Œæˆï¼ç¸½è€—æ™‚ " + finalTime + " ç§’ã€‚\nè¦å†ç©ä¸€æ¬¡å—ï¼Ÿ")) {
                document.getElementById('gameArea').style.display = 'none';
                document.getElementById('controlBox').style.display = 'block';
            }
        }, 500);
    }
</script>

</body>
</html>
