<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 5éµå°é‹¼ç´</title>
    <style>
        body { background-color: #222; color: white; text-align: center; font-family: sans-serif; user-select: none; touch-action: manipulation;}
        
        .controls { margin: 20px; padding: 10px; background: #333; border-radius: 15px; display: inline-block;}
        select { font-size: 20px; padding: 10px; border-radius: 5px; margin-right: 10px; }
        
        .btn-connect { font-size: 18px; padding: 10px 15px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin: 5px;}
        #btnBtn { background: #00d4ff; color: #000; }
        #btnLed { background: #ff4444; color: #fff; }
        .connected { opacity: 0.5; cursor: default; }

        /* èª¿æ•´æŒ‰éµå¯¬åº¦ï¼Œå› ç‚ºè®Šå°‘äº†ï¼Œå¯ä»¥åšå¤§ä¸€é» */
        .key { width: 18%; height: 120px; margin: 5px; display: inline-block; background: white; border-radius: 10px; color: black; line-height: 120px; font-size: 30px; font-weight: bold; border: 5px solid #000; transition: transform 0.05s;}
        .active { background-color: #6eff6e; transform: scale(0.95); }
        .target { border-color: #ff4444; box-shadow: 0 0 20px #ff4444; z-index: 10; position: relative; background-color: #fff0f0;}
        
        #targetDisplay { font-size: 50px; color: yellow; margin: 20px; min-height: 60px;}
        #progressBar { width: 80%; height: 15px; background: #555; margin: 10px auto; border-radius: 10px; overflow: hidden; }
        #progressFill { height: 100%; background: #00d4ff; width: 0%; transition: width 0.3s; }
        #status { color: #888; margin-bottom: 20px;}
        #piano-container { display: flex; justify-content: center; padding: 10px; }
    </style>
</head>
<body>

    <div class="controls">
        <select id="songSelect">
            <option value="scale">ğŸµ éŸ³éšç·´ç¿’ (1-5)</option>
            <option value="bee">ğŸ å°èœœèœ‚</option>
            <option value="lamb">ğŸ‘ ç‘ªè‰æœ‰éš»å°ç¶¿ç¾Š</option>
            <option value="joy">ğŸ¼ æ­¡æ¨‚é Œ (è²å¤šèŠ¬)</option>
        </select>
        <br>
        <button id="btnBtn" class="btn-connect">1. é€£æ¥æŒ‰éˆ•æ¿</button>
        <button id="btnLed" class="btn-connect">2. é€£æ¥ç‡ˆå…‰æ¿</button>
    </div>

    <div id="status">è«‹é€£æ¥å…©å€‹ ESP32</div>
    
    <div id="targetDisplay">ç›®æ¨™: Do</div>
    <div id="progressBar"><div id="progressFill"></div></div>
    
    <div id="piano-container"></div>

    <script>
        // UUID è¨­å®š
        const BTN_SERVICE = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
        const BTN_TX_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; 
        const LED_SERVICE = "6e400001-b5a3-f393-e0a9-e50e24dcca9f";
        const LED_RX_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9f";

        // --- 5éŸ³å°ˆç”¨æ¨‚è­œ ---
        const songs = {
            // éŸ³éš
            "scale": [1, 2, 3, 4, 5, 5, 4, 3, 2, 1],
            
            // å°èœœèœ‚ (åªéœ€è¦ 1~5)
            "bee": [
                5, 3, 3, 4, 2, 2, 1, 2, 3, 4, 5, 5, 5,
                5, 3, 3, 4, 2, 2, 1, 3, 5, 5, 1,
                2, 2, 2, 2, 2, 3, 4,
                3, 3, 3, 3, 3, 4, 5,
                5, 3, 3, 4, 2, 2, 1, 3, 5, 5, 1
            ],

            // ç‘ªè‰æœ‰éš»å°ç¶¿ç¾Š (åªéœ€è¦ 1, 2, 3, 5)
            "lamb": [
                3, 2, 1, 2, 3, 3, 3,
                2, 2, 2, 3, 5, 5,
                3, 2, 1, 2, 3, 3, 3, 
                3, 2, 2, 3, 2, 1
            ],

            // æ­¡æ¨‚é Œ (ä¸»é¡Œéƒ¨åˆ†åªéœ€è¦ 1~5)
            "joy": [
                3, 3, 4, 5, 5, 4, 3, 2,
                1, 1, 2, 3, 3, 2, 2,
                3, 3, 4, 5, 5, 4, 3, 2,
                1, 1, 2, 3, 2, 1, 1
            ]
        };

        const notesName = ["", "Do", "Re", "Mi", "Fa", "Sol"]; // åªç”¨åˆ° 1~5
        let currentSong = songs["scale"];
        let noteIndex = 0;
        
        let rxCharLED;
        let isPressed = false;
        let isBtnConnected = false;
        let isLedConnected = false;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const audioBuffers = {}; 

        async function loadSound(i) {
            try {
                // åªéœ€è¦è¼‰å…¥ 1.wav ~ 5.wav
                const response = await fetch(i + '.wav');
                if(!response.ok) throw new Error("Missing");
                const arrayBuffer = await response.arrayBuffer();
                audioBuffers[i] = await audioCtx.decodeAudioData(arrayBuffer);
            } catch(e) { console.log("Missing sound: " + i); }
        }
        function playSound(soundId) {
            if (audioBuffers[soundId]) {
                const source = audioCtx.createBufferSource();
                source.buffer = audioBuffers[soundId];
                source.connect(audioCtx.destination);
                source.start(0);
            }
        }
        
        // é è¼‰ 1~5 å³å¯
        Promise.all([
            loadSound(1), loadSound(2), loadSound(3), loadSound(4), loadSound(5)
        ]).then(() => { document.getElementById("status").innerText = "éŸ³æ•ˆå°±ç·’ (1-5)"; });

        // å»ºç½® UI (åªç”¢ç”Ÿ 5 å€‹éµ)
        const container = document.getElementById("piano-container");
        for(let i=1; i<=5; i++) {
            let div = document.createElement("div");
            div.className = "key"; div.id = "key-" + i; div.innerText = notesName[i];
            container.appendChild(div);
        }
        updateGameUI();

        document.getElementById('songSelect').addEventListener('change', function() {
            currentSong = songs[this.value];
            noteIndex = 0;
            updateGameUI();
            sendLightCommand();
            document.getElementById('status').innerText = "å·²åˆ‡æ›æ›²ç›®";
            this.blur();
        });

        // é€£æ¥æŒ‰éˆ•æ¿
        document.getElementById('btnBtn').addEventListener('click', async function() {
            if (audioCtx.state === 'suspended') { await audioCtx.resume(); }
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'ESP32 5-Key BTN' }],
                    optionalServices: [BTN_SERVICE]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(BTN_SERVICE);
                const txChar = await service.getCharacteristic(BTN_TX_UUID);
                await txChar.startNotifications();
                txChar.addEventListener('characteristicvaluechanged', handleInput);

                this.innerText = "æŒ‰éˆ•æ¿ OK";
                this.classList.add("connected");
                isBtnConnected = true;
                checkAllConnected();
            } catch (e) { alert("æŒ‰éˆ•æ¿é€£ç·šå¤±æ•—: " + e); }
        });

        // é€£æ¥ç‡ˆå…‰æ¿
        document.getElementById('btnLed').addEventListener('click', async function() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'ESP32 5-Key LED' }],
                    optionalServices: [LED_SERVICE]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(LED_SERVICE);
                rxCharLED = await service.getCharacteristic(LED_RX_UUID);

                this.innerText = "ç‡ˆå…‰æ¿ OK";
                this.classList.add("connected");
                isLedConnected = true;
                checkAllConnected();
            } catch (e) { alert("ç‡ˆå…‰æ¿é€£ç·šå¤±æ•—: " + e); }
        });

        function checkAllConnected() {
            if(isBtnConnected && isLedConnected) {
                document.getElementById('status').innerText = "é›™æ¿é€£ç·šæˆåŠŸï¼";
                sendLightCommand();
            }
        }

        function handleInput(event) {
            let val = new TextDecoder().decode(event.target.value);
            let char = val.charAt(0);
            let userNote = -1; let press = false;

            // A~E å°æ‡‰ 1~5
            if (char >= 'A' && char <= 'E') { userNote = char.charCodeAt(0) - 64; press = true; } 
            else if (char >= 'a' && char <= 'e') { userNote = char.charCodeAt(0) - 96; press = false; }

            if (userNote >= 1 && userNote <= 5) {
                let keyDiv = document.getElementById("key-" + userNote);
                let targetNote = currentSong[noteIndex];

                if (press) {
                    keyDiv.classList.add("active");
                    if (userNote == targetNote) {
                        playSound(userNote);
                        isPressed = true;
                        document.getElementById("targetDisplay").style.color = "#6eff6e";
                    } else {
                        document.getElementById("targetDisplay").innerText = "éŒ¯äº†ï¼è«‹æŒ‰ " + notesName[targetNote];
                        document.getElementById("targetDisplay").style.color = "red";
                    }
                } else {
                    keyDiv.classList.remove("active");
                    if (userNote == targetNote && isPressed) {
                        isPressed = false;
                        noteIndex++; 
                        if (noteIndex >= currentSong.length) {
                            noteIndex = 0;
                            setTimeout(() => { alert("å®Œæˆï¼"); updateGameUI(); sendLightCommand(); }, 200);
                        } else {
                            updateGameUI();
                            sendLightCommand(); 
                        }
                    }
                }
            }
        }

        async function sendLightCommand() {
            if (rxCharLED) {
                let targetNote = currentSong[noteIndex];
                let data = new TextEncoder().encode(targetNote.toString());
                await rxCharLED.writeValue(data);
            }
        }

        function updateGameUI() {
            let targetNote = currentSong[noteIndex];
            document.getElementById("targetDisplay").innerText = "ç›®æ¨™: " + notesName[targetNote];
            document.getElementById("targetDisplay").style.color = "yellow";

            for(let i=1; i<=5; i++) {
                let el = document.getElementById("key-" + i);
                if(i === targetNote) el.classList.add("target");
                else el.classList.remove("target");
            }
            let progress = (noteIndex / currentSong.length) * 100;
            document.getElementById("progressFill").style.width = progress + "%";
        }
    </script>
</body>
</html>
