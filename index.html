<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 é‹¼ç´ (å®Œç¾éŸ³é«˜ç‰ˆ)</title>
    <style>
        body { background-color: #222; color: white; text-align: center; font-family: sans-serif; user-select: none; touch-action: manipulation;}
        
        .controls { margin: 20px; padding: 10px; background: #333; border-radius: 15px; display: inline-block;}
        select { font-size: 20px; padding: 10px; border-radius: 5px; margin-right: 10px; }
        #connectBtn { font-size: 20px; padding: 10px 20px; background: #00d4ff; color: #000; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;}
        
        .key { width: 90%; height: 60px; margin: 10px auto; background: white; border-radius: 10px; color: black; line-height: 60px; font-size: 24px; font-weight: bold; border: 5px solid #000; transition: transform 0.05s;}
        .active { background-color: #6eff6e; transform: scale(0.95); }
        .target { border-color: #ff4444; box-shadow: 0 0 15px #ff4444; z-index: 10; position: relative;}
        
        #targetDisplay { font-size: 40px; color: yellow; margin: 20px; min-height: 50px;}
        #progressBar { width: 80%; height: 10px; background: #555; margin: 10px auto; border-radius: 5px; overflow: hidden; }
        #progressFill { height: 100%; background: #00d4ff; width: 0%; transition: width 0.3s; }
        #status { color: #888; margin-bottom: 20px;}
    </style>
</head>
<body>

    <div class="controls">
        <select id="songSelect">
            <option value="bee">ğŸ å°èœœèœ‚</option>
            <option value="star">ğŸŒŸ å°æ˜Ÿæ˜Ÿ</option>
            <option value="happy">ğŸ‚ ç”Ÿæ—¥å¿«æ¨‚æ­Œ (å®Œç¾ç‰ˆ)</option>
            <option value="tiger">ğŸ¯ å…©éš»è€è™ (å®Œç¾ç‰ˆ)</option>
        </select>
        <button id="connectBtn">é€£æ¥é‹¼ç´</button>
    </div>

    <div id="status">è«‹ä¸Šå‚³ 0.wav å’Œ 8.wav ä»¥ç²å¾—æœ€ä½³é«”é©—</div>
    
    <div id="targetDisplay">ç›®æ¨™: Sol</div>
    <div id="progressBar"><div id="progressFill"></div></div>
    
    <div id="piano-container"></div>

    <script>
        const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
        const RX_UUID      = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; 
        const TX_UUID      = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; 

        // --- æ¨‚è­œè³‡æ–™åº« ---
        // é€™è£¡çš„æ•¸å­—ä»£è¡¨ã€Œè¦äº®å“ªé¡†ç‡ˆã€ä»¥åŠã€Œè¦æŒ‰å“ªé¡†éµã€
        const songs = {
            "bee": [
                5, 3, 3, 4, 2, 2, 1, 2, 3, 4, 5, 5, 5,
                5, 3, 3, 4, 2, 2, 1, 3, 5, 5, 1,
                2, 2, 2, 2, 2, 3, 4,
                3, 3, 3, 3, 3, 4, 5,
                5, 3, 3, 4, 2, 2, 1, 3, 5, 5, 1
            ],
            "star": [
                1, 1, 5, 5, 6, 6, 5,
                4, 4, 3, 3, 2, 2, 1,
                5, 5, 4, 4, 3, 3, 2,
                5, 5, 4, 4, 3, 3, 2,
                1, 1, 5, 5, 6, 6, 5,
                4, 4, 3, 3, 2, 2, 1
            ],
            "happy": [
                1, 1, 2, 1, 4, 3,
                1, 1, 2, 1, 5, 4,
                1, 1, 1, 6, 4, 3, 2, // ç¬¬ä¸‰å€‹ 1 æ˜¯é«˜æ½®ï¼Œè¦ç™¼é«˜éŸ³
                7, 7, 6, 4, 5, 4
            ],
            "tiger": [
                1, 2, 3, 1, 1, 2, 3, 1,
                3, 4, 5, 3, 4, 5,
                5, 6, 5, 4, 3, 1,
                5, 6, 5, 4, 3, 1,
                2, 5, 1, 2, 5, 1 // ä¸­é–“çš„ 5 è¦ç™¼ä½éŸ³
            ]
        };

        // --- ç‰¹æ®ŠéŸ³é«˜å°ç…§è¡¨ (Magic Map) ---
        // æ ¼å¼: "æ›²ç›®åç¨±": { "ç¬¬å¹¾å€‹éŸ³(ç´¢å¼•)": "è¦æ’­æ”¾çš„ç‰¹æ®ŠéŸ³æ•ˆID" }
        // ç´¢å¼•å¾ 0 é–‹å§‹ç®—
        const soundOverrides = {
            "happy": {
                14: 8 // ç”Ÿæ—¥å¿«æ¨‚æ­Œç¬¬ 15 å€‹éŸ³(ç´¢å¼•14)ï¼ŒæŒ‰éµæ˜¯1ï¼Œä½†è²éŸ³æ’­ 8.wav (é«˜éŸ³Do)
            },
            "tiger": {
                25: 0, // å…©éš»è€è™ç¬¬ 26 å€‹éŸ³ï¼ŒæŒ‰éµæ˜¯5ï¼Œä½†è²éŸ³æ’­ 0.wav (ä½éŸ³Sol)
                29: 0  // å…©éš»è€è™ç¬¬ 30 å€‹éŸ³ï¼ŒåŒä¸Š
            }
        };

        const notesName = ["", "Do", "Re", "Mi", "Fa", "Sol", "La", "Si"];
        let currentSong = songs["bee"];
        let noteIndex = 0;
        let selectedSongKey = "bee"; // ç´€éŒ„ç›®å‰é¸åˆ°çš„æ­Œå
        
        let bleDevice, rxChar;
        let isPressed = false;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const audioBuffers = {}; 

        async function loadSound(i) {
            try {
                const response = await fetch(i + '.wav');
                if(!response.ok) throw new Error("File not found");
                const arrayBuffer = await response.arrayBuffer();
                audioBuffers[i] = await audioCtx.decodeAudioData(arrayBuffer);
            } catch(e) { console.log("éŸ³æ•ˆ " + i + " å°šæœªä¸Šå‚³ (å¦‚æœæ˜¯ 0 æˆ– 8 å¯æš«æ™‚å¿½ç•¥)"); }
        }

        function playSound(soundId) {
            if (audioBuffers[soundId]) {
                const source = audioCtx.createBufferSource();
                source.buffer = audioBuffers[soundId];
                source.connect(audioCtx.destination);
                source.start(0);
            } else {
                // å¦‚æœæ‰¾ä¸åˆ°ç‰¹æ®ŠéŸ³æ•ˆ (ä¾‹å¦‚ 8.wav æ²’ä¸Šå‚³)ï¼Œå°±é€€å›å»æ’­åŸæœ¬çš„è²éŸ³
                console.log("ç¼ºå°‘éŸ³æ•ˆ: " + soundId + ".wav");
            }
        }

        // é è¼‰ 1~7 ä»¥åŠç‰¹æ®Šçš„ 0, 8
        Promise.all([
            loadSound(1), loadSound(2), loadSound(3), 
            loadSound(4), loadSound(5), loadSound(6), loadSound(7),
            loadSound(0), loadSound(8) // æ–°å¢é€™å…©å€‹
        ]).then(() => {
            document.getElementById("status").innerText = "éŸ³æ•ˆè¼‰å…¥å®Œæˆï¼Œè«‹é€£æ¥";
        });

        const container = document.getElementById("piano-container");
        for(let i=1; i<=7; i++) {
            let div = document.createElement("div");
            div.className = "key"; div.id = "key-" + i; div.innerText = notesName[i];
            container.appendChild(div);
        }
        updateGameUI();

        document.getElementById('songSelect').addEventListener('change', function() {
            selectedSongKey = this.value;
            currentSong = songs[selectedSongKey];
            noteIndex = 0;
            updateGameUI();
            sendLightCommand();
            document.getElementById('status').innerText = "å·²åˆ‡æ›æ›²ç›®";
            this.blur();
        });

        document.getElementById('connectBtn').addEventListener('click', async () => {
            if (audioCtx.state === 'suspended') { await audioCtx.resume(); }

            try {
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'ESP32 Piano Fast' }],
                    optionalServices: [SERVICE_UUID]
                });

                const server = await bleDevice.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                rxChar = await service.getCharacteristic(RX_UUID);
                const txChar = await service.getCharacteristic(TX_UUID);

                await txChar.startNotifications();
                txChar.addEventListener('characteristicvaluechanged', handleInput);

                document.getElementById("status").innerText = "å·²é€£ç·šï¼";
                document.getElementById("connectBtn").style.display = "none";
                document.getElementById("songSelect").disabled = false;
                
                sendLightCommand();

            } catch (error) {
                alert("é€£ç·šå¤±æ•—ï¼š" + error);
            }
        });

        function handleInput(event) {
            let val = new TextDecoder().decode(event.target.value);
            let char = val.charAt(0);
            let userNote = -1; let press = false;

            if (char >= 'A' && char <= 'G') { userNote = char.charCodeAt(0) - 64; press = true; } 
            else if (char >= 'a' && char <= 'g') { userNote = char.charCodeAt(0) - 96; press = false; }

            if (userNote >= 1 && userNote <= 7) {
                let keyDiv = document.getElementById("key-" + userNote);
                let targetNote = currentSong[noteIndex];

                if (press) {
                    keyDiv.classList.add("active");
                    
                    if (userNote == targetNote) {
                        // === é—œéµä¿®æ”¹ï¼šåˆ¤æ–·æ˜¯å¦è¦æ’­æ”¾ç‰¹æ®ŠéŸ³æ•ˆ ===
                        let soundToPlay = userNote; // é è¨­æ’­åŸæœ¬çš„éŸ³ (ä¾‹å¦‚æŒ‰1æ’­1)

                        // æª¢æŸ¥ç¾åœ¨é€™é¦–æ­Œã€é€™å€‹é€²åº¦ï¼Œæœ‰æ²’æœ‰ç‰¹æ®ŠæŒ‡å®š
                        if (soundOverrides[selectedSongKey] && soundOverrides[selectedSongKey][noteIndex] !== undefined) {
                            soundToPlay = soundOverrides[selectedSongKey][noteIndex];
                            console.log("è§¸ç™¼ç‰¹æ®ŠéŸ³æ•ˆ: " + soundToPlay);
                        }

                        playSound(soundToPlay);
                        // ==========================================

                        isPressed = true;
                        document.getElementById("targetDisplay").style.color = "#6eff6e";
                    } else {
                        document.getElementById("targetDisplay").innerText = "éŒ¯äº†ï¼è«‹æŒ‰ " + notesName[targetNote];
                        document.getElementById("targetDisplay").style.color = "red";
                    }
                } else {
                    keyDiv.classList.remove("active");
                    if (userNote == targetNote && isPressed) {
                        isPressed = false;
                        noteIndex++; 
                        if (noteIndex >= currentSong.length) {
                            noteIndex = 0;
                            setTimeout(() => {
                                alert("æ­å–œå®Œæˆå…¨æ›²ï¼");
                                updateGameUI();
                                sendLightCommand();
                            }, 200);
                        } else {
                            updateGameUI();
                            sendLightCommand(); 
                        }
                    }
                }
            }
        }

        async function sendLightCommand() {
            if (rxChar) {
                let targetNote = currentSong[noteIndex];
                let data = new TextEncoder().encode(targetNote.toString());
                await rxChar.writeValue(data);
            }
        }

        function updateGameUI() {
            let targetNote = currentSong[noteIndex];
            
            // å¦‚æœæ˜¯ç‰¹æ®ŠéŸ³ï¼ŒåŠ å€‹æç¤ºç¬¦è™Ÿ
            let displayName = notesName[targetNote];
            if (soundOverrides[selectedSongKey] && soundOverrides[selectedSongKey][noteIndex] == 8) {
                displayName += " (é«˜éŸ³!)";
            } else if (soundOverrides[selectedSongKey] && soundOverrides[selectedSongKey][noteIndex] == 0) {
                displayName += " (ä½éŸ³!)";
            }

            document.getElementById("targetDisplay").innerText = "ç›®æ¨™: " + displayName;
            document.getElementById("targetDisplay").style.color = "yellow";

            for(let i=1; i<=7; i++) {
                let el = document.getElementById("key-" + i);
                if(i === targetNote) el.classList.add("target");
                else el.classList.remove("target");
            }

            let progress = (noteIndex / currentSong.length) * 100;
            document.getElementById("progressFill").style.width = progress + "%";
        }
    </script>
</body>
</html>
