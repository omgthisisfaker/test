<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 é‹¼ç´éŠæˆ² (æœ€çµ‚æ•´åˆç‰ˆ)</title>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; text-align: center; background: #222; color: white; padding-top: 20px;}
        .box { border: 1px solid #555; padding: 20px; margin: 15px auto; max-width: 500px; border-radius: 10px; background: #333; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; border: none; margin: 5px;}
        .btn-connect { background: #007bff; color: white; }
        .btn-start { background: #28a745; color: white; font-size: 24px; padding: 15px 40px; display: none;}
        .status-ok { color: #4cff00; font-weight: bold; }
        
        #gameArea { display: none; margin-top: 30px; }
        .timer { font-size: 40px; color: #00d2ff; font-family: monospace; }
        .note-display { font-size: 80px; color: yellow; font-weight: bold; margin: 20px 0; }
        .instruction { color: #ff9999; font-size: 18px; margin-bottom: 10px;}
        
        /* éŸ³é‡æ‹‰æ¡¿å€åŸŸ (é è¨­éš±è—) */
        .vol-container { margin: 20px 0; padding: 15px; background: #444; border-radius: 5px; border: 1px solid #666; }
        input[type=range] { width: 80%; cursor: pointer; }
        
        .debug-area { margin-top: 50px; border-top: 1px solid #555; padding-top: 20px; color: gray; font-size: 0.8em; }
    </style>
</head>
<body>

    <h1>ğŸµ ESP32 é‹¼ç´æŒ‘æˆ° (æœ€çµ‚ç‰ˆ)</h1>

    <div class="box">
        <h3>1. è£ç½®é€£ç·š</h3>
        <p>LEDæ¿: <span id="ledStatus">æœªé€£ç·š âŒ</span> <button class="btn-connect" onclick="connectLed()">é€£æ¥</button></p>
        <p>æŒ‰éˆ•æ¿: <span id="btnStatus">æœªé€£ç·š âŒ</span> <button class="btn-connect" onclick="connectBtn()">é€£æ¥</button></p>
        
        <div class="vol-container" id="volControl" style="display:none;">
            <p>ğŸ”Š å–‡å­éŸ³é‡: <span id="volVal">25</span>%</p>
            <input type="range" min="0" max="100" value="25" oninput="updateVolume(this.value)">
            <p style="font-size: 12px; color: #ccc;">(ç›´æ¥æ§åˆ¶ ESP32 çš„å–‡å­å¤§å°)</p>
        </div>
    </div>

    <div class="box" id="controlBox">
        <h3>2. é¸æ“‡é—œå¡</h3>
        <select id="songSelect" style="padding: 10px; font-size: 16px; width: 80%;">
            <option value="3,2,1,2,3,3,3,2,2,2,3,5,5,3,2,1,2,3,3,3,3,2,2,3,2,1">ç‘ªè‰æœ‰éš»å°ç¶¿ç¾Š (å®Œæ•´ç‰ˆ)</option>
            <option value="5,3,3,4,2,2,1,2,3,4,5,5,5,2,2,2,2,2,3,4,3,3,3,3,3,4,5,5,3,3,4,2,2,1,3,5,5,1">å°èœœèœ‚ (å®Œæ•´ç‰ˆ)</option>
            <option value="3,3,3,3,3,3,3,5,1,2,3,4,4,4,4,4,3,3,3,3,2,2,1,2,5">è–èª•éˆ´è² (å®Œæ•´ç‰ˆ)</option>
            <option value="1,2,3,4,5,5,4,3,2,1,1,2,3,4,5,5,4,3,2,1">éŸ³éšä¾†å›è·‘ (å…©è¶Ÿ)</option>
            <option value="1,3,5,2,4,1,5,3,4,2,3,1,4,2,5,1,3,2,4,5">é­”é¬¼äº‚è·³ (20é€£æ“Š)</option>
        </select>
        <br><br>
        <button id="startBtn" class="btn-start" onclick="startGame()">é–‹å§‹éŠæˆ²ï¼</button>
    </div>

    <div id="gameArea">
        <div class="instruction">çœ‹åˆ°ç‡ˆäº® -> æŒ‰ä¸‹å¯¦é«”æŒ‰éˆ•</div>
        <div class="timer"><span id="timeDisplay">0.00</span> ç§’</div>
        <div class="note-display" id="currentNote">-</div>
        <div id="logMsg" style="font-size: 14px; color: #aaa;">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <div class="debug-area">
        <p>é™¤éŒ¯è¨Šæ¯: <span id="debugText">ç„¡</span></p>
    </div>

<script>
    // --- UUID è¨­å®š (å¿…é ˆèˆ‡ ESP32 ç¨‹å¼ç¢¼ä¸€è‡´) ---
    const LED_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const LED_CHAR = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
    
    // æŒ‰éˆ•æ¿çš„ UUID
    const BTN_SERVICE_UUID = "1234c201-1fb5-459e-8fcc-c5c9c331914b";
    const BTN_NOTIFY_UUID  = "5678483e-36e1-4688-b7f5-ea07361b26a8"; // æ¥æ”¶æŒ‰éˆ•è¨Šè™Ÿ
    const BTN_VOL_UUID     = "9012483e-36e1-4688-b7f5-ea07361b26a8"; // å‚³é€éŸ³é‡æ§åˆ¶

    let ledChar = null;
    let volChar = null; 
    let isPlaying = false;
    let song = [];
    let index = 0;
    let startTime = 0;
    let timerInt = null;

    function log(msg) { document.getElementById('debugText').innerText = msg; console.log(msg); }

    // --- é€£æ¥ LED æ¿ ---
    async function connectLed() {
        try {
            const dev = await navigator.bluetooth.requestDevice({
                filters: [{name:'ESP32_LED_Control'}], 
                optionalServices:[LED_UUID]
            });
            const srv = await dev.gatt.connect();
            const svc = await srv.getPrimaryService(LED_UUID);
            ledChar = await svc.getCharacteristic(LED_CHAR);
            
            document.getElementById('ledStatus').innerHTML = "å·²é€£ç·š âœ…";
            document.getElementById('ledStatus').className = "status-ok";
            checkReady();
        } catch(e){ alert("LEDé€£ç·šå¤±æ•—: " + e); }
    }

    // --- é€£æ¥ æŒ‰éˆ•æ¿ (åŒæ™‚å–å¾— æŒ‰éˆ•è¨Šè™Ÿ èˆ‡ éŸ³é‡ç‰¹å¾µ) ---
    async function connectBtn() {
        try {
            log("æ­£åœ¨æœå°‹ ESP32_Button_Input...");
            const dev = await navigator.bluetooth.requestDevice({
                filters: [{name:'ESP32_Button_Input'}], 
                optionalServices:[BTN_SERVICE_UUID]
            });
            const srv = await dev.gatt.connect();
            const svc = await srv.getPrimaryService(BTN_SERVICE_UUID);
            
            // 1. è¨‚é–±æŒ‰éˆ•é€šçŸ¥ (Notify)
            const notifyChar = await svc.getCharacteristic(BTN_NOTIFY_UUID);
            await notifyChar.startNotifications();
            notifyChar.addEventListener('characteristicvaluechanged', onBtnPress);
            
            // 2. å–å¾—éŸ³é‡æ§åˆ¶ (Write)
            try {
                volChar = await svc.getCharacteristic(BTN_VOL_UUID);
                document.getElementById('volControl').style.display = 'block'; // é¡¯ç¤ºæ‹‰æ¡¿
                updateVolume(25); // åˆå§‹åŒ–éŸ³é‡
            } catch(e) { log("è­¦å‘Š: æ‰¾ä¸åˆ°éŸ³é‡ç‰¹å¾µï¼Œå¯èƒ½æ˜¯ç¨‹å¼æ²’æ›´æ–°"); }

            document.getElementById('btnStatus').innerHTML = "å·²é€£ç·š âœ…";
            document.getElementById('btnStatus').className = "status-ok";
            checkReady();
        } catch(e){ alert("æŒ‰éˆ•é€£ç·šå¤±æ•—: " + e + "\nè«‹ç¢ºèªè—ç‰™æ˜¯å¦å·²é–‹å•Ÿä¸”åç¨±æ­£ç¢º"); }
    }

    // --- æ›´æ–°éŸ³é‡ ---
    function updateVolume(val) {
        document.getElementById('volVal').innerText = val;
        if(volChar) {
            // å°‡æ•¸å­—è½‰æˆå­—ä¸²å‚³çµ¦ ESP32
            volChar.writeValue(new TextEncoder().encode(String(val)));
        }
    }

    function checkReady() {
        if(ledChar && document.getElementById('btnStatus').className.includes("status-ok")){
            document.getElementById('startBtn').style.display = "inline-block";
        }
    }

    // --- éŠæˆ²é‚è¼¯ ---
    function startGame() {
        song = document.getElementById('songSelect').value.split(',').map(Number);
        index = 0;
        isPlaying = true;
        document.getElementById('controlBox').style.display = 'none';
        document.getElementById('gameArea').style.display = 'block';
        
        startTime = Date.now();
        timerInt = setInterval(() => {
            let t = (Date.now() - startTime) / 1000;
            document.getElementById('timeDisplay').innerText = t.toFixed(2);
        }, 30);
        playNote();
    }

    function playNote() {
        // æª¢æŸ¥æ˜¯å¦éé—œ
        if(index >= song.length) {
            clearInterval(timerInt);
            setTimeout(finishGame, 1000); // å»¶é² 1 ç§’å†è·³é€šçŸ¥
            return;
        }
        let target = song[index];
        document.getElementById('currentNote').innerText = target;
        document.getElementById('logMsg').innerText = "è«‹æŒ‰æŒ‰éˆ•: " + target;
        
        // ç™¼è¨Šè™Ÿçµ¦ LED æ¿äº®ç‡ˆ
        if(ledChar) ledChar.writeValue(new TextEncoder().encode(String(target)));
    }

    function onBtnPress(event) {
        if(!isPlaying) return;
        
        let val = new TextDecoder().decode(event.target.value);
        let pressed = parseInt(val);
        let target = song[index];

        log("æ”¶åˆ°: " + pressed + " ç›®æ¨™: " + target);

        if(pressed === target) {
            // ç­”å°äº† (è²éŸ³ç”± ESP32 è‡ªå·±æ’­ï¼Œé€™è£¡åªè™•ç†éŠæˆ²é€²åº¦)
            index++;
            // ç¨å¾®å»¶é²ä¸€é»é»å†äº®ä¸‹ä¸€å€‹ç‡ˆï¼Œé¿å…è¦–è¦ºå¤ªå¿«
            setTimeout(playNote, 50); 
        } else {
            document.getElementById('logMsg').innerText = "âŒ æŒ‰éŒ¯äº†ï¼ç›®æ¨™æ˜¯ " + target;
        }
    }

    function finishGame() {
        isPlaying = false;
        if(ledChar) ledChar.writeValue(new TextEncoder().encode('0')); // é—œç‡ˆ
        document.getElementById('currentNote').innerText = "ğŸ‰";
        
        // çµæŸå¾Œç­‰å¾…ä¸€ä¸‹è·³å‡ºè¦–çª—
        setTimeout(() => {
            alert("æ­å–œå®Œæˆï¼ç¸½æ™‚é–“: " + document.getElementById('timeDisplay').innerText + " ç§’");
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('controlBox').style.display = 'block';
        }, 500);
    }
</script>
</body>
</html>
