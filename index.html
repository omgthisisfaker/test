<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ESP32 éŸ³æ¨‚åæ‡‰æŒ‘æˆ° (æœ‰è²ç‰ˆ)</title>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; text-align: center; background: #222; color: white; padding-top: 20px;}
        .box { border: 1px solid #555; padding: 20px; margin: 15px auto; max-width: 500px; border-radius: 10px; background: #333; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; border: none; margin: 5px;}
        .btn-connect { background: #007bff; color: white; }
        .btn-start { background: #28a745; color: white; font-size: 24px; padding: 15px 40px; display: none;}
        .status-ok { color: #4cff00; font-weight: bold; }
        
        #gameArea { display: none; margin-top: 30px; }
        .timer { font-size: 40px; color: #00d2ff; font-family: monospace; }
        .note-display { font-size: 80px; color: yellow; font-weight: bold; margin: 20px 0; }
        .score-text { color: #aaa; margin-top: 10px; font-size: 14px;}
        .instruction { color: #ff9999; font-size: 18px; margin-bottom: 10px;}
    </style>
</head>
<body>

    <h1>ğŸµ 5éµåæ‡‰é€Ÿåº¦æŒ‘æˆ° (æœ‰è²ç‰ˆ)</h1>

    <div class="box">
        <h3>1. è£ç½®é€£ç·š</h3>
        <p>LEDæ¿: <span id="ledStatus">æœªé€£ç·š âŒ</span> <button class="btn-connect" onclick="connectLed()">é€£æ¥</button></p>
        <p>æŒ‰éˆ•æ¿: <span id="btnStatus">æœªé€£ç·š âŒ</span> <button class="btn-connect" onclick="connectBtn()">é€£æ¥</button></p>
    </div>

    <div class="box" id="controlBox">
        <h3>2. é¸æ“‡é—œå¡</h3>
        <select id="songSelect" style="padding: 10px; font-size: 16px; width: 80%;">
            <option value="3,2,1,2,3,3,3,2,2,2,3,5,5">ç‘ªè‰æœ‰éš»å°ç¶¿ç¾Š</option>
            <option value="5,3,3,4,2,2,1,2,3,4,5,5,5">å°èœœèœ‚</option>
            <option value="3,3,3,3,3,3,3,5,1,2,3">è–èª•éˆ´è²</option>
            <option value="1,2,3,4,5,5,4,3,2,1">éŸ³éšä¾†å›è·‘</option>
            <option value="1,3,5,2,4,1,5,3,4,2">é­”é¬¼äº‚è·³</option>
        </select>
        <br><br>
        <button id="startBtn" class="btn-start" onclick="startGame()">é–‹å§‹éŠæˆ²ï¼</button>
    </div>

    <div id="gameArea">
        <div class="instruction">è·Ÿè‘—è²éŸ³èˆ‡ç‡ˆå…‰æŒ‰ä¸‹æŒ‰éˆ•ï¼</div>
        <div class="timer"><span id="timeDisplay">0.00</span> ç§’</div>
        <div class="note-display" id="currentNote">-</div>
        <div class="score-text" id="songPreview"></div>
    </div>

<script>
    // --- è—ç‰™ UUID è¨­å®š ---
    const LED_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const LED_CHAR = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
    const BTN_UUID = "1234c201-1fb5-459e-8fcc-c5c9c331914b";
    const BTN_CHAR = "5678483e-36e1-4688-b7f5-ea07361b26a8";

    let ledChar = null;
    let isPlaying = false;
    let song = [];
    let index = 0;
    let startTime = 0;
    let timerInt = null;

    // --- éŸ³æ•ˆå¼•æ“ (Web Audio API) ---
    let audioCtx = null;
    
    // éŸ³é »é »ç‡ (å°æ‡‰ Do, Re, Mi, Fa, Sol)
    // 1=C4, 2=D4, 3=E4, 4=F4, 5=G4
    const NOTES = {
        1: 261.63,
        2: 293.66,
        3: 329.63,
        4: 349.23,
        5: 392.00
    };

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
    }

    function playTone(note, duration = 0.3) {
        if (!audioCtx) return;
        if (!NOTES[note]) return;

        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        osc.type = 'triangle'; // æ³¢å½¢ï¼šsine, square, triangle, sawtooth
        osc.frequency.value = NOTES[note];
        
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        osc.start();
        
        // è²éŸ³æ·¡å‡ºæ•ˆæœï¼Œé¿å…çˆ†éŸ³
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);

        osc.stop(audioCtx.currentTime + duration);
    }

    // --- é€£ç·šåŠŸèƒ½ ---
    async function connectLed() {
        try {
            const dev = await navigator.bluetooth.requestDevice({filters: [{name:'ESP32_LED_Control'}], optionalServices:[LED_UUID]});
            const srv = await dev.gatt.connect();
            const svc = await srv.getPrimaryService(LED_UUID);
            ledChar = await svc.getCharacteristic(LED_CHAR);
            document.getElementById('ledStatus').innerHTML = "å·²é€£ç·š âœ…";
            document.getElementById('ledStatus').className = "status-ok";
            checkReady();
        } catch(e){alert("LEDé€£ç·šå¤±æ•—:"+e);}
    }

    async function connectBtn() {
        try {
            const dev = await navigator.bluetooth.requestDevice({filters: [{name:'ESP32_Button_Input'}], optionalServices:[BTN_UUID]});
            const srv = await dev.gatt.connect();
            const svc = await srv.getPrimaryService(BTN_UUID);
            const char = await svc.getCharacteristic(BTN_CHAR);
            await char.startNotifications();
            char.addEventListener('characteristicvaluechanged', onBtnPress);
            document.getElementById('btnStatus').innerHTML = "å·²é€£ç·š âœ…";
            document.getElementById('btnStatus').className = "status-ok";
            checkReady();
        } catch(e){alert("æŒ‰éˆ•é€£ç·šå¤±æ•—:"+e);}
    }

    function checkReady() {
        if(ledChar && document.getElementById('btnStatus').className.includes("status-ok")){
            document.getElementById('startBtn').style.display = "inline-block";
        }
    }

    // --- éŠæˆ²é‚è¼¯ ---
    function startGame() {
        // å•Ÿå‹•è²éŸ³å¼•æ“ (ç€è¦½å™¨è¦å®šå¿…é ˆåœ¨äº’å‹•å¾Œå•Ÿå‹•)
        initAudio();
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }

        song = document.getElementById('songSelect').value.split(',').map(Number);
        index = 0;
        isPlaying = true;
        
        document.getElementById('controlBox').style.display = 'none';
        document.getElementById('gameArea').style.display = 'block';
        document.getElementById('songPreview').innerText = "æ¨‚è­œé•·åº¦: " + song.length + " å€‹éŸ³";
        document.getElementById('timeDisplay').innerText = "0.00";

        startTime = Date.now();
        timerInt = setInterval(() => {
            let t = (Date.now() - startTime) / 1000;
            document.getElementById('timeDisplay').innerText = t.toFixed(2);
        }, 30);

        playNote(); // äº®ç¬¬ä¸€å€‹ç‡ˆ
    }

    function playNote() {
        if(index >= song.length) {
            finishGame();
            return;
        }
        let target = song[index];
        document.getElementById('currentNote').innerText = target;
        
        // 1. ç™¼é€è—ç‰™è¨Šè™Ÿäº®ç‡ˆ
        if(ledChar) ledChar.writeValue(new TextEncoder().encode(String(target)));

        // 2. ç¶²é ç™¼å‡ºè²éŸ³æç¤º
        playTone(target, 0.5); 
    }

    function onBtnPress(event) {
        if(!isPlaying) return;
        
        // è®€å–æŒ‰éˆ•è¨Šè™Ÿ
        let val = new TextDecoder().decode(event.target.value);
        let pressed = parseInt(val);
        let target = song[index];

        console.log("ç›®æ¨™:", target, "æŒ‰ä¸‹:", pressed);

        // åˆ¤å®šï¼šåªæœ‰æŒ‰å°äº†æ‰è·³ä¸‹ä¸€å€‹
        if(pressed === target) {
            index++;
            playNote(); // æ’­æ”¾ä¸‹ä¸€å€‹éŸ³
        } else {
            // æŒ‰éŒ¯æ™‚å¯ä»¥åŠ å€‹éŒ¯èª¤éŸ³æ•ˆ(é¸é…)
            // playTone(1, 0.1); 
        }
    }

    function finishGame() {
        isPlaying = false;
        clearInterval(timerInt);
        let finalTime = document.getElementById('timeDisplay').innerText;
        
        // é—œç‡ˆ
        if(ledChar) ledChar.writeValue(new TextEncoder().encode('0'));

        document.getElementById('currentNote').innerText = "ğŸ‰";
        
        // æ’­æ”¾å‹åˆ©éŸ³æ•ˆ (Do-Mi-Sol-Do)
        setTimeout(() => playTone(1, 0.2), 0);
        setTimeout(() => playTone(3, 0.2), 200);
        setTimeout(() => playTone(5, 0.2), 400);
        setTimeout(() => playTone(1, 0.4), 600); // é«˜éŸ³Doé »ç‡æ²’å¯«ï¼Œé€™è£¡æš«æ™‚ç”¨ä½éŸ³Doä»£æ›¿ï¼Œæˆ–è€…ä½ å¯ä»¥åŠ é€²å­—å…¸

        setTimeout(() => {
            alert("æ­å–œå®Œæˆï¼ç¸½æ™‚é–“: " + finalTime + " ç§’");
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('controlBox').style.display = 'block';
        }, 1000);
    }
</script>
</body>
</html>
